<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <link rel="stylesheet" href="theme.css"/>
  <title>Testing D3 and Leaflet maps</title>
  <p id="chart"></p>

  <! load json>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <! color styling>
  <script src="https://d3js.org/d3-scale.v3.min.js"></script>

  
  <! load leaflet>
  <! MUST USE THEIR STYLESHEET>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
	integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
	crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
	  integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
	  crossorigin=""></script>

<script src="leaflet-slider/dist/leaflet-slider.js"></script>
  <script>

    var map = L.map('chart').setView([-33.864144, 151.202774], 13);


    L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    var indicator_names = [];
	var features = [];
	var geojson;
	var popup = L.popup();

    d3.csv('dummy-data-tlbr-indicators.csv', function(err, dat) {
	
	dat.forEach(function(row) {

	    // unpack coordinates
	    var x1 = Number(row.tl_lat),
		y1 = Number(row.tl_lon),
		x2 = Number(row.br_lat),
		y2 = Number(row.br_lon)

	    // generate indicators
	    var names = {}
	    for (var i = 4; i<dat.columns.length; i++) {
		names[dat.columns[i]] = Number(row[dat.columns[i]])
		indicator_names.push(dat.columns[i])
	    }
	    features.push({
		"type": "Feature",
		"properties": {
		    "indicators": names
		},
		"geometry": {
		    "type": "Polygon",
		    "coordinates": [
			[
			    [y1, x1],
			    [y2, x1],
			    [y2, x2],
			    [y1, x2],
			    [y1, x1]
			]
		    ]
		}
	    })

	})
	var color = d3.scaleLinear()
	    .domain([0, 5, 10])
	    .range(["red", "transparent", "green"]);

	function style(feature) {
	    var indicators = feature.properties.indicators
	    var wmean = 0
	    indicator_names.forEach(function (indicator) {
		wmean = wmean + indicators[indicator] // * weight from slider
	    })
		
	    wmean = wmean / indicator_names.length // sum of absolute weights from sliders


		indicators.wmean = wmean

	    return {
		fillColor: color(wmean),
		weight: 2,
		opacity: 0,
		color: 'white',
		dashArray: '3',
		fillOpacity: 0.7
	    };
	}

		geojson = L.geoJson({"type": "FeatureCollection", "features": features},
			{style: style,
			onEachFeature: onEachFeature}).addTo(map)
		})
	

	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
		var layer = e.target;
		console.log(layer)

		popup
		.setLatLng(e.latlng)
		.setContent("Your Indicator 4 is "+ + layer.feature.properties.indicators.indicator_4 +  "<br />" + e.latlng.toString())
		.openOn(map);

	}

	function onEachFeature(feature, layer) {
	layer.on({
		mouseover: highlightFeature,
		mouseout: resetHighlight,
		click: zoomToFeature
	});
}

	function highlightFeature(e) {
		var layer = e.target;
		console.log(e.target)

		layer.setStyle({
			fillColor: 'white',
			weight: 10,
			color: 'blue',
			dashArray: '',
			fillOpacity: 0.7
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
		console.log(layer.feature.properties)

	}

	function resetHighlight(e) {
		geojson.resetStyle(e.target);
		info.update();
	}

	var info = L.control();

	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
		this.update();
		return this._div;
	};

	// method that we will use to update the control based on feature properties passed
	info.update = function (props) {
		this._div.innerHTML = '<div class="info"><h4>Precinct Success Indicators</h4>' +  (props ?
			'<br />' + props.indicators.indicator_1 + ' Indicator 1' +
			'<br />' + props.indicators.indicator_2 + ' people / km<sup>2</sup>' +
			'<br /><b>' + props.indicators.indicator_3 + ' Indicator 3 Score' +
			'</div>'
			: 'Hover over an area');
	};


slider = L.control.slider(function(value) {
    			console.log(value);
			}, {
    		min: 2000,
			max: 2030,
    		value: 2019,
			position: 'topright',
    		step: 1,
    		size: '210px',
    		orientation:'horizontal',
			logo: 'Changes Over Time',
			title: 'Time frame',
    		id: 'slider'
		}).addTo(map);

		slider1 = L.control.slider(function(value) {
    			console.log(value);
			}, {
    		min: 10,
			max: 300,
    		value: 30,
			position: 'topleft',
    		step: 1,
    		size: '150px',
    		orientation:'horizontal',
			logo: 'Population Density',
			title: 'Time frame',
    		id: 'slider1'
		}).addTo(map);

		slider2 = L.control.slider(function(value) {
    			console.log(value);
			}, {
    		min: 10000,
			max: 80000,
    		value: 40000,
			position: 'topleft',
    		step: 1,
    		size: '150px',
    		orientation:'horizontal',
			logo: 'Purchasing Power',
			title: 'Time frame',
    		id: 'slider2'
		}).addTo(map);

		slider3 = L.control.slider(function(value) {
    			console.log(value);
			}, {
    		min: 300,
			max: 4000,
    		value: 1000,
			position: 'topleft',
    		step: 1,
    		size: '200px',
    		orientation:'horizontal',
			logo: 'Congestion',
			title: 'Time frame',
    		id: 'slider3'
		}).addTo(map);

		info.addTo(map);


  </script>

<style>
		.leaflet-control-slider {
			height: 100px;
			background-color: white; 
			padding: 15px;
			border-radius: 10px;
			box-shadow: 0px 0px 2px 2px rgb(138, 137, 137); 
		}
		
		.leaflet-control-slider-value {
			font-size: 15px;
			margin-left: 40%;
		}

		.leaflet-control-slider-toggle {
			font-size: 20px;
			font-weight: bold;
		}

		.leaflet-container a {
			color: black;
		}

		/* .info-box {
			background-color: white;
			padding: 15px;
			box-shadow: 0px 0px 2px 2px rgb(138, 137, 137); 
		} */


		.info {
	padding: 6px 8px;
	font: 14px/16px Arial, Helvetica, sans-serif;
	background: white;
	background: rgba(255,255,255,0.8);
	box-shadow: 0 0 15px rgba(0,0,0,0.2);
	border-radius: 5px;
	}

	.info h4 {
		margin: 0 0 5px;
		color: #777;
	}
	</style>
</html>

